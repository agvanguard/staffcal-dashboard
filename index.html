<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StaffCal - CHT Staffing Calendar Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 30px;
            text-align: center;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header .subtitle {
            font-size: 1.2em;
            margin-top: 10px;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 300;
        }

        .controls {
            padding: 30px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        select, input {
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .button {
            background: #10b981;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .calendar-container {
            background: white;
            border-radius: 16px;
            margin: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .calendar-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .nav-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e2e8f0;
        }

        .day-header {
            padding: 15px;
            background: #374151;
            color: white;
            font-weight: 600;
            text-align: center;
            font-size: 14px;
        }

        .calendar-day {
            min-height: 140px;
            border: none;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .calendar-day:hover {
            background: #f0f9ff;
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }

        .day-number {
            font-weight: 600;
            margin-bottom: 6px;
            color: #374151;
            font-size: 14px;
            text-align: center;
        }

        .team-info {
            margin-bottom: 4px;
            padding: 4px;
            border-radius: 4px;
            font-size: 10px;
            line-height: 1.2;
            border: 1px solid #e2e8f0;
            background: #f8fafc;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal h3 {
            color: #374151;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .controls { flex-direction: column; }
            .calendar-day { min-height: 100px; padding: 4px; }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <div style="display: flex; align-items: center; justify-content: center; gap: 20px;">
                <div style="width: 60px; height: 60px;">
                    <svg width="60" height="60" viewBox="0 0 200 200">
                        <rect x="20" y="40" width="160" height="140" rx="20" fill="white" stroke="#1e3a8a" stroke-width="8"/>
                        <circle cx="65" cy="20" r="15" fill="#1e3a8a"/>
                        <circle cx="135" cy="20" r="15" fill="#1e3a8a"/>
                        <rect x="55" y="8" width="20" height="25" rx="10" fill="#06b6d4"/>
                        <rect x="125" y="8" width="20" height="25" rx="10" fill="#06b6d4"/>
                        <rect x="30" y="50" width="140" height="25" fill="#f97316"/>
                        <circle cx="80" cy="115" r="8" fill="#1e3a8a"/>
                        <circle cx="120" cy="115" r="8" fill="#1e3a8a"/>
                        <path d="M 70 135 Q 100 155 130 135" stroke="#1e3a8a" stroke-width="4" fill="none"/>
                        <rect x="60" y="150" width="20" height="15" rx="3" fill="#06b6d4"/>
                        <rect x="90" y="150" width="20" height="15" rx="3" fill="#f97316"/>
                        <rect x="120" y="150" width="20" height="15" rx="3" fill="#fbbf24"/>
                        <rect x="50" y="180" width="25" height="15" rx="12" fill="#1e3a8a"/>
                        <rect x="125" y="180" width="25" height="15" rx="12" fill="#1e3a8a"/>
                    </svg>
                </div>
                <h1>StaffCal</h1>
            </div>
            <div class="subtitle">CHT Staffing Calendar Dashboard</div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label>üìä Data Management</label>
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <input type="file" id="csvFile" accept=".csv" style="display: none;">
                    <button class="button" onclick="document.getElementById('csvFile').click()">üìÇ Import</button>
                    <button class="button" onclick="downloadCSV()" style="background: #0891b2;">üìä Download</button>
                    <button class="button" onclick="showHelp()" style="background: #6b7280;">‚ùì Help</button>
                    <button class="button" onclick="debugData()" style="background: #ef4444;">üîç Debug</button>
                </div>
            </div>

            <div class="control-group">
                <label>Queue (LOB)</label>
                <select id="queueFilter" onchange="updateCalendarDisplay()">
                    <option value="all">All Queues</option>
                </select>
            </div>

            <div class="control-group">
                <label>Channel</label>
                <select id="channelFilter" onchange="updateCalendarDisplay()">
                    <option value="all">All Channels</option>
                </select>
            </div>

            <div class="control-group">
                <label>Status</label>
                <div id="dataStatus" style="padding: 8px 12px; border-radius: 8px; font-size: 12px; background: #6b7280; color: white; font-weight: 600;">
                    Ready to import
                </div>
            </div>
        </div>

        <div class="calendar-container">
            <div class="calendar-header">
                <button class="nav-button" onclick="navigateMonth(-1)">‚Äπ Previous</button>
                <h2 id="currentMonth">January 2025</h2>
                <button class="nav-button" onclick="navigateMonth(1)">Next ‚Ä∫</button>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>
    </div>

    <div id="detailModal" class="modal" onclick="if(event.target===this) closeModal()">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal()">&times;</button>
            <h3 id="modalTitle">Details</h3>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        let assembledData = [];
        let processedData = {};
        let availableQueues = new Set();
        let availableChannels = new Set();
        let currentDate = new Date();
        let dataSource = 'sample';

        const SPREADSHEET_ID = '15YqO6JxqZXKRq27ApxL9RNdW3Ujg5ps4LV7ZrmmLG34';
        const SUMMARY_TAB_GID = '1527296774';

        const sampleData = { '2025-01-27': { 'Sample': { total: 25, required: 20, net_staffing: 5, queue: 'Sample', channel: 'email', hourly: {} }}};

        function downloadCSV() {
            const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/export?format=csv&gid=${SUMMARY_TAB_GID}`;
            const a = document.createElement('a');
            a.href = url;
            a.download = 'staffing.csv';
            a.click();
            updateDataStatus('üìä Downloading...', '#0891b2');
        }

        document.getElementById('csvFile').addEventListener('change', e => {
            if (!e.target.files[0]) return;
            updateDataStatus('‚è≥ Loading...', '#fbbf24');
            
            const reader = new FileReader();
            reader.onload = e => parseCSV(e.target.result);
            reader.readAsText(e.target.files[0]);
        });

        function parseCSV(text) {
            const lines = text.split('\n');
            const headers = parseLine(lines[0]).map(h => h.trim().replace(/"/g, ''));
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const vals = parseLine(line);
                const row = {};
                headers.forEach((h, j) => row[h] = (vals[j] || '').trim().replace(/"/g, ''));
                
                if (Object.values(row).some(v => v)) data.push(row);
            }

            assembledData = data;
            console.log(`‚úÖ Loaded ${data.length} rows`);
            processData();
        }

        function parseLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let char of line) {
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else current += char;
            }
            result.push(current);
            return result;
        }

        function processData() {
            console.log('üîÑ Processing data with Column H capture...');
            
            processedData = {};
            availableQueues.clear();
            availableChannels.clear();

            assembledData.forEach((row, idx) => {
                const cols = Object.values(row);
                
                const date = formatDate(cols[0]);
                const time = cols[1] || '';
                const channel = (cols[3] || '').trim();
                const queue = (cols[4] || '').trim();
                const F = parseFloat(cols[5] || 0);
                const G = parseFloat(cols[6] || 0);
                const H = parseFloat(cols[7] || 0);

                if (!date || !queue || !channel) return;

                availableQueues.add(queue);
                availableChannels.add(channel);

                const key = `${queue}|${channel}`;

                if (!processedData[date]) processedData[date] = {};
                if (!processedData[date][key]) {
                    processedData[date][key] = {
                        queue, 
                        channel,
                        sumF: 0, 
                        sumG: 0,
                        hourly: {}
                    };
                }

                // Accumulate Column F and G sums
                processedData[date][key].sumF += F;
                processedData[date][key].sumG += G;

                // Accumulate Column H values per hour
                const hour = getHour(time);
                if (hour !== null) {
                    if (!processedData[date][key].hourly[hour]) {
                        processedData[date][key].hourly[hour] = { staffing_net: 0 };
                    }
                    // SUM Column H values for this hour
                    processedData[date][key].hourly[hour].staffing_net += H;
                }
            });

            // Calculate final daily values using the formula
            Object.values(processedData).forEach(dateData => {
                Object.values(dateData).forEach(q => {
                    q.total = q.sumF / 7.5;                    // Scheduled = Sum(F) √∑ 7.5
                    q.required = q.sumG / 7.5;                 // Required = Sum(G) √∑ 7.5
                    q.net_staffing = q.total - q.required;     // Net = Scheduled - Required
                    delete q.sumF;
                    delete q.sumG;
                });
            });

            dataSource = 'assembled';
            updateFilterDropdowns();
            updateCalendarDisplay();
            updateDataStatus(`‚úÖ ${assembledData.length} records`, '#10b981');
            console.log('‚úÖ Complete - Column H summed per hour');
        }

        function getHour(timeStr) {
            const t = timeStr.toString().trim().toLowerCase();
            
            if (t.includes('am') || t.includes('pm')) {
                const isPM = t.includes('pm');
                const time = t.replace(/\s*(am|pm)/g, '').trim();
                
                if (time.includes(':')) {
                    let h = parseInt(time.split(':')[0]);
                    if (isNaN(h)) return null;
                    if (isPM && h !== 12) h += 12;
                    else if (!isPM && h === 12) h = 0;
                    return (h >= 0 && h <= 23) ? h : null;
                }
            }
            
            if (t.includes(':')) {
                const h = parseInt(t.split(':')[0]);
                return (h >= 0 && h <= 23) ? h : null;
            }
            
            return null;
        }

        function formatDate(d) {
            if (!d) return new Date().toISOString().split('T')[0];
            if (d.includes('/')) {
                const [m, day, y] = d.split('/');
                return `${y}-${m.padStart(2,'0')}-${day.padStart(2,'0')}`;
            }
            const date = new Date(d);
            return !isNaN(date) ? date.toISOString().split('T')[0] : new Date().toISOString().split('T')[0];
        }

        function updateDataStatus(msg, color) {
            document.getElementById('dataStatus').textContent = msg;
            document.getElementById('dataStatus').style.backgroundColor = color;
        }

        function updateFilterDropdowns() {
            const qF = document.getElementById('queueFilter');
            const cF = document.getElementById('channelFilter');
            
            qF.innerHTML = '<option value="all">All Queues</option>';
            Array.from(availableQueues).sort().forEach(q => {
                const opt = document.createElement('option');
                opt.value = opt.textContent = q;
                qF.appendChild(opt);
            });
            
            cF.innerHTML = '<option value="all">All Channels</option>';
            Array.from(availableChannels).sort().forEach(c => {
                const opt = document.createElement('option');
                opt.value = opt.textContent = c;
                cF.appendChild(opt);
            });
        }

        function getFilteredData() {
            const selQ = document.getElementById('queueFilter').value;
            const selC = document.getElementById('channelFilter').value;
            
            const source = dataSource === 'assembled' ? processedData : sampleData;
            const filtered = {};
            
            Object.entries(source).forEach(([date, dateData]) => {
                const matches = [];
                
                Object.entries(dateData).forEach(([key, qData]) => {
                    const q = qData.queue || key.split('|')[0];
                    const c = qData.channel || key.split('|')[1] || '';
                    
                    if (selQ !== 'all' && q !== selQ) return;
                    if (selC !== 'all' && c.toLowerCase() !== selC.toLowerCase()) return;
                    
                    matches.push({ queue: q, channel: c, data: qData });
                });
                
                if (!matches.length) return;
                
                // Aggregate if "All" is selected for queue or channel
                if (selQ === 'all' || selC === 'all') {
                    const name = selQ === 'all' && selC === 'all' ? 'All Queues (All Channels)' :
                               selQ === 'all' ? `All Queues (${selC})` : `${selQ} (All Channels)`;
                    
                    let sumF = 0, sumG = 0;
                    const aggHourly = {};
                    
                    matches.forEach(m => {
                        // Reverse the division to get original Column F and G sums
                        sumF += (m.data.total || 0) * 7.5;
                        sumG += (m.data.required || 0) * 7.5;
                        
                        // Sum hourly Column H values
                        if (m.data.hourly) {
                            Object.entries(m.data.hourly).forEach(([h, hData]) => {
                                if (!aggHourly[h]) aggHourly[h] = { staffing_net: 0 };
                                aggHourly[h].staffing_net += (hData.staffing_net || 0);
                            });
                        }
                    });
                    
                    filtered[date] = {
                        [name]: {
                            total: sumF / 7.5,
                            required: sumG / 7.5,
                            net_staffing: (sumF / 7.5) - (sumG / 7.5),
                            hourly: aggHourly,
                            displayName: name,
                            originalQueue: selQ,
                            originalChannel: selC
                        }
                    };
                } else {
                    // Show individual queue-channel entries
                    filtered[date] = {};
                    matches.forEach(m => {
                        const key = `${m.queue} (${m.channel})`;
                        filtered[date][key] = {
                            ...m.data,
                            displayName: key,
                            originalQueue: m.queue,
                            originalChannel: m.channel
                        };
                    });
                }
            });
            
            return filtered;
        }

        function updateCalendarDisplay() {
            const months = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            
            document.getElementById('currentMonth').textContent = 
                `${months[currentDate.getMonth()]} ${currentDate.getFullYear()}`;

            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                const el = document.createElement('div');
                el.className = 'day-header';
                el.textContent = day;
                grid.appendChild(el);
            });

            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const start = new Date(firstDay);
            start.setDate(start.getDate() - firstDay.getDay());

            const filtered = getFilteredData();
            const today = new Date();

            for (let i = 0; i < 42; i++) {
                const date = new Date(start);
                date.setDate(start.getDate() + i);
                
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                dayEl.onclick = () => showDayDetails(date);

                const num = document.createElement('div');
                num.className = 'day-number';
                num.textContent = date.getDate();
                
                if (date.getMonth() !== currentDate.getMonth()) dayEl.style.opacity = '0.4';

                if (date.toDateString() === today.toDateString()) {
                    Object.assign(num.style, {
                        backgroundColor: '#4facfe', color: 'white', borderRadius: '50%',
                        width: '28px', height: '28px', display: 'flex',
                        alignItems: 'center', justifyContent: 'center', margin: '0 auto'
                    });
                }

                dayEl.appendChild(num);

                const dateKey = date.toISOString().split('T')[0];
                if (filtered[dateKey]) {
                    Object.values(filtered[dateKey]).forEach(d => {
                        const info = document.createElement('div');
                        info.className = 'team-info';
                        info.innerHTML = `
                            <div style="font-weight: 600; font-size: 10px; margin-bottom: 2px;">${d.displayName}</div>
                            <div style="font-size: 8px; text-align: center;">
                                <div style="color: #1e40af;">üìä ${(d.total || 0).toFixed(1)}</div>
                                <div style="color: #1e40af;">üìã ${(d.required || 0).toFixed(1)}</div>
                                <div style="color: #059669;">üéØ ${(d.net_staffing || 0).toFixed(1)}</div>
                            </div>
                        `;
                        dayEl.appendChild(info);
                    });
                }

                grid.appendChild(dayEl);
            }
        }

        function navigateMonth(dir) {
            currentDate.setMonth(currentDate.getMonth() + dir);
            updateCalendarDisplay();
        }

        function showDayDetails(date) {
            const dateKey = date.toISOString().split('T')[0];
            const filtered = getFilteredData();
            const dayData = filtered[dateKey] || {};

            let content = `<h4>üìä ${date.toDateString()}</h4>
                <div style="background: #f0f9ff; padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 13px;">
                    <strong>Formula:</strong> Sch=Œ£(F)√∑7.5 | Req=Œ£(G)√∑7.5 | Net=Sch-Req | Hourly=Œ£(H)
                </div>`;

            if (Object.keys(dayData).length) {
                Object.values(dayData).forEach(d => {
                    content += `
                        <div style="margin: 15px 0; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden;">
                            <div style="background: #4facfe; color: white; padding: 12px; font-weight: 600;">${d.displayName}</div>
                            <div style="padding: 15px;">
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">
                                    <div style="text-align: center; padding: 10px; border: 2px solid #1e40af; border-radius: 8px;">
                                        <div style="font-weight: 600; color: #1e40af;">Scheduled</div>
                                        <div style="font-size: 18px; color: #1e40af;">${(d.total || 0).toFixed(1)}</div>
                                    </div>
                                    <div style="text-align: center; padding: 10px; border: 2px solid #1e40af; border-radius: 8px;">
                                        <div style="font-weight: 600; color: #1e40af;">Required</div>
                                        <div style="font-size: 18px; color: #1e40af;">${(d.required || 0).toFixed(1)}</div>
                                    </div>
                                    <div style="text-align: center; padding: 10px; border: 2px solid #1e40af; border-radius: 8px;">
                                        <div style="font-weight: 600; color: #1e40af;">Net</div>
                                        <div style="font-size: 18px; color: #1e40af;">${(d.net_staffing || 0).toFixed(1)}</div>
                                    </div>
                                </div>
                    `;

                    if (d.hourly && Object.keys(d.hourly).length) {
                        content += `<h5 style="margin: 10px 0;">‚è∞ Hourly Net Staffing (Column H Sum):</h5>
                            <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 3px;">`;

                        for (let hour = 0; hour < 24; hour++) {
                            const hData = d.hourly[hour];
                            const val = hData ? hData.staffing_net : null;
                            const hasData = val !== null && val !== undefined;
                            
                            let color = '#6b7280', bg = '#f3f4f6';
                            if (hasData) {
                                if (val > 5) { color = '#059669'; bg = '#dcfce7'; }
                                else if (val >= 1) { color = '#d97706'; bg = '#fef3c7'; }
                                else { color = '#dc2626'; bg = '#fecaca'; }
                            }

                            content += `
                                <div style="text-align: center; padding: 6px 2px; background: ${bg}; border: 1px solid ${color}; border-radius: 4px; font-size: 10px;">
                                    <div style="font-weight: 600; color: ${color}; margin-bottom: 2px;">${hour.toString().padStart(2, '0')}:00</div>
                                    <div style="color: ${color}; font-weight: 600; font-size: 9px;">${hasData ? val.toFixed(3) : '-'}</div>
                                </div>
                            `;
                        }

                        content += `</div>
                            <div style="margin-top: 10px; padding: 8px; background: #f8fafc; border-radius: 6px; font-size: 11px; text-align: center;">
                                Green (>5) | Yellow (1-5) | Red (<1) | Gray (No Data)
                            </div>`;
                    }

                    content += `
                                <div style="margin-top: 10px; font-size: 12px; color: #6b7280;">
                                    Queue: ${d.originalQueue || 'All'} | Channel: ${d.originalChannel || 'All'}
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                content += '<p style="text-align: center; color: #6b7280; margin: 20px 0;">No data available</p>';
            }

            showModal(date.toDateString(), content);
        }

        function showModal(title, content) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalContent').innerHTML = content + 
                '<div style="text-align: center; margin-top: 20px;"><button onclick="closeModal()" style="background: #4facfe; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer;">Close</button></div>';
            document.getElementById('detailModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        function showHelp() {
            showModal('How to Use StaffCal', `
                <div style="background: #e0f2fe; padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                    <h5 style="margin-bottom: 10px;">üöÄ Quick Start:</h5>
                    <ol style="margin-left: 20px; line-height: 1.8;">
                        <li>Click "Download" to get CSV from Google Sheets</li>
                        <li>Click "Import" and select the CSV file</li>
                        <li>Use Queue/Channel filters to analyze specific teams</li>
                        <li>Navigate months using ‚Üê ‚Üí arrows</li>
                        <li>Click any date to see detailed hourly breakdown</li>
                    </ol>
                </div>
                <div style="background: #dcfce7; padding: 15px; border-radius: 12px;">
                    <h5 style="margin-bottom: 10px;">üìà Calculation Formula:</h5>
                    <div style="font-size: 14px; line-height: 1.6;">
                        ‚Ä¢ <strong>Scheduled</strong> = Sum of Column F √∑ 7.5<br>
                        ‚Ä¢ <strong>Required</strong> = Sum of Column G √∑ 7.5<br>
                        ‚Ä¢ <strong>Net Staffing</strong> = Scheduled - Required<br>
                        ‚Ä¢ <strong>Hourly Values</strong> = Sum of Column H per hour interval
                    </div>
                </div>
            `);
        }

        function debugData() {
            const selQ = document.getElementById('queueFilter').value;
            const selC = document.getElementById('channelFilter').value;
            
            const info = {
                totalRecords: assembledData.length,
                currentFilters: {
                    queue: selQ,
                    channel: selC
                },
                availableQueues: Array.from(availableQueues).sort(),
                availableChannels: Array.from(availableChannels),
                processedDates: Object.keys(processedData).sort(),
                sampleRawData: assembledData.slice(0, 3).map(r => {
                    const c = Object.values(r);
                    return { date: c[0], time: c[1], queue: c[4], channel: c[3], F: c[5], G: c[6], H: c[7] };
                })
            };

            // Analyze current month's data based on selected filters
            const currentMonthKey = `${currentDate.getFullYear()}-${(currentDate.getMonth() + 1).toString().padStart(2, '0')}`;
            const currentMonthDates = Object.keys(processedData).filter(d => d.startsWith(currentMonthKey));
            
            if (currentMonthDates.length > 0) {
                info.currentMonthAnalysis = {
                    month: `${currentDate.getMonth() + 1}/${currentDate.getFullYear()}`,
                    datesWithData: currentMonthDates.length,
                    sampleDate: currentMonthDates[0]
                };

                // Analyze a sample date from current month
                const sampleDateKey = currentMonthDates[0];
                const sampleDateData = processedData[sampleDateKey];
                
                info.sampleDateBreakdown = {
                    date: sampleDateKey,
                    queueChannelCombinations: Object.keys(sampleDateData).length,
                    combinations: {}
                };

                Object.entries(sampleDateData).forEach(([key, val]) => {
                    const matchesFilter = (selQ === 'all' || val.queue === selQ) && 
                                         (selC === 'all' || val.channel.toLowerCase() === selC.toLowerCase());
                    
                    if (matchesFilter) {
                        info.sampleDateBreakdown.combinations[key] = {
                            scheduled: val.total,
                            required: val.required,
                            net: val.net_staffing,
                            hourly_hours_with_data: Object.keys(val.hourly).length,
                            sample_hourly: Object.fromEntries(Object.entries(val.hourly).slice(0, 3))
                        };
                    }
                });
            }

            // If specific queue is selected, analyze that queue across all dates
            if (selQ !== 'all') {
                const queueDates = Object.keys(processedData).filter(date => {
                    return Object.keys(processedData[date]).some(key => key.includes(selQ));
                });

                info.selectedQueueAnalysis = {
                    queue: selQ,
                    channel: selC,
                    datesWithData: queueDates.length,
                    sampleDates: queueDates.slice(0, 5)
                };

                // Detailed analysis for first date with this queue
                if (queueDates.length > 0) {
                    const testDate = queueDates[0];
                    const testData = processedData[testDate];
                    
                    Object.entries(testData).forEach(([key, val]) => {
                        if (key.includes(selQ) && (selC === 'all' || val.channel.toLowerCase() === selC.toLowerCase())) {
                            info.selectedQueueDetailedExample = {
                                date: testDate,
                                key: key,
                                scheduled: val.total,
                                required: val.required,
                                net: val.net_staffing,
                                hourlyBreakdown: val.hourly
                            };
                        }
                    });
                }
            }

            // Raw data verification for currently selected filters
            if (assembledData.length > 0 && currentMonthDates.length > 0) {
                const testDate = currentMonthDates[0];
                const rawDateEntries = assembledData.filter(r => {
                    const c = Object.values(r);
                    const date = formatDate(c[0]);
                    const queue = (c[4] || '').trim();
                    const channel = (c[3] || '').trim().toLowerCase();
                    
                    const matchesDate = date === testDate;
                    const matchesQueue = selQ === 'all' || queue === selQ;
                    const matchesChannel = selC === 'all' || channel === selC.toLowerCase();
                    
                    return matchesDate && matchesQueue && matchesChannel;
                });

                let rawSumF = 0, rawSumG = 0;
                const rawHourlyH = {};
                
                rawDateEntries.forEach(r => {
                    const c = Object.values(r);
                    rawSumF += parseFloat(c[5] || 0);
                    rawSumG += parseFloat(c[6] || 0);
                    
                    const hour = getHour(c[1]);
                    const H = parseFloat(c[7] || 0);
                    if (hour !== null) {
                        if (!rawHourlyH[hour]) rawHourlyH[hour] = 0;
                        rawHourlyH[hour] += H;
                    }
                });

                info.RAW_DATA_VERIFICATION = {
                    testDate: testDate,
                    matchingRawRows: rawDateEntries.length,
                    raw_sum_F: rawSumF,
                    raw_sum_G: rawSumG,
                    EXPECTED_scheduled: (rawSumF / 7.5).toFixed(3),
                    EXPECTED_required: (rawSumG / 7.5).toFixed(3),
                    EXPECTED_net: ((rawSumF / 7.5) - (rawSumG / 7.5)).toFixed(3),
                    raw_hourly_H_sums: rawHourlyH,
                    sample_3_rows: rawDateEntries.slice(0, 3).map(r => {
                        const c = Object.values(r);
                        return {
                            time: c[1],
                            queue: c[4],
                            channel: c[3],
                            F: c[5],
                            G: c[6],
                            H: c[7]
                        };
                    })
                };
            }
            
            showModal('üîç Debug Analysis - Current Filters', `
                <div style="font-family: monospace; font-size: 10px; max-height: 500px; overflow: auto; background: #f8fafc; padding: 15px; border-radius: 8px;">
                    <div style="font-family: sans-serif; background: #fef3c7; padding: 10px; border-radius: 6px; margin-bottom: 10px;">
                        <strong>Current Filters:</strong> Queue: ${selQ} | Channel: ${selC}
                    </div>
                    <pre>${JSON.stringify(info, null, 2)}</pre>
                </div>
            `);
        }

        function initialize() {
            processedData = sampleData;
            availableQueues = new Set(['Sample']);
            availableChannels = new Set(['email']);
            dataSource = 'sample';
            updateFilterDropdowns();
            updateCalendarDisplay();
        }

        initialize();
    </script>
</body>
</html>
